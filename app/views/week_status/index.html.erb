
<% 
categories = Hash.new

categories = {"Extreme Black" => "+450km", "Extreme Red" => "+350km", "Black" => "+250km",
        "Purple" => "+150km","Blue" => "+100km", "Green" => "+75km",
        "Orange" => "+50km", "Yellow" => "+25km", "White" => "0-24km"}


def speed_avatar_helper(speed)

  if speed >= 17.1
    "peregrine_falcon"
  elsif speed >= 15 && speed < 17.1
    "golden_eagle"
  elsif speed >= 13.3 && speed < 15
    "cheetah"
  elsif speed >= 12 && speed < 1.3
    "ostrish"
  elsif speed >= 10.9 && speed < 12
    "pronghorn_antelope"
  elsif speed >= 10 && speed < 10.9
    "blue_wildebeest"    
  elsif speed >= 9.2 && speed < 17.1
    "brown_hare"
  elsif speed >= 8.6 && speed < 17.1
    "red_fox"
  elsif speed >= 7.5 && speed < 17.1
    "mustang_horse"
  else
    "black_manba_snake"
  end
end 

%>


<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;border-color:#000000;}
.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#000000;color:#669;background-color:#e8edff;border-top-width:1px;border-bottom-width:1px;}
.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;border-color:#000000;color:#039;background-color:#e0e0eb;border-top-width:1px;border-bottom-width:1px;}
.tg .tg-u34r{font-weight:bold;font-size:13px;font-family:Arial, Helvetica, sans-serif !important;;color:#000000;text-align:right;vertical-align:middle;}
.tg .tg-f2ra{font-weight:bold;background-color:#ffffff;color:#656565;vertical-align:middle}
.tg .tg-3x04{background-color:#ffffff;color:#656565;vertical-align:middle}
.tg .tg-ovtd{background-color:#ffffff;font-weight:bold;color:#656565;vertical-align:middle}
.tg .tg-tdrf{background-color:#fe0000;font-weight:bold;color:#ffffff;text-align:center;vertical-align:middle}
.tg .tg-yi30{font-weight:bold;font-size:15px;font-family:Arial, Helvetica, sans-serif !important;;color:#000000;text-align:center;vertical-align:middle}
.tg .tg-z8q4{background-color:#000000;font-weight:bold;color:#ffffff;text-align:center;vertical-align:middle}
.tg .tg-qacf{font-size:13px;font-family:Arial, Helvetica, sans-serif !important;;color:#000000;vertical-align:middle}
.tg .tg-6eia{font-weight:bold;font-size:13px;font-family:Arial, Helvetica, sans-serif !important;;color:#000000;vertical-align:middle}
.tg .tg-scrz{font-weight:bold;background-color:#ffffff;color:#000000;text-align:center;vertical-align:middle}
.tg .tg-9d65{font-weight:bold;background-color:#ffffff;color:#000000;vertical-align:middle}
.tg .tg-pxng{background-color:#ffffff;color:#000000;vertical-align:middle}
.tg .tg-oskr{background-color:#ffffff;vertical-align:middle}
.tg .tg-3we0{background-color:#ffffff;vertical-align:middle}
.tg .tg-5jp5{background-color:#ffffff;color:#656565;vertical-align:middle}
.tg .Black{background-color:#000000;font-weight:bold;color:#ffffff;text-align:center;vertical-align:middle}
.tg .Red{background-color:#FF0000;font-weight:bold;color:#ffffff;text-align:center;vertical-align:middle}
.tg .Green{background-color:#008000;font-weight:bold;color:#ffffff;text-align:center;vertical-align:middle}
.tg .Purple{background-color:#800080 ;font-weight:bold;color:#ffffff;text-align:center;vertical-align:middle}
.tg .Orange{background-color:#FFA500;font-weight:bold;color:#ffffff;text-align:center;vertical-align:middle}
.tg .Blue{background-color:#0000FF;font-weight:bold;color:#ffffff;text-align:center;vertical-align:middle}
.tg .Yellow{background-color:#FFFF00;font-weight:bold;color:#000000;text-align:center;vertical-align:middle}
.tg .White{background-color:#FFFFFF;font-weight:bold;color:#000000;text-align:center;vertical-align:middle}

.progress {
  margin-bottom: 0;
  border-radius: 5px;
  padding-top:0px; display:inline-block;
  font-size:10px;
  height: 23px;
  width: 50px;
  text-align:center;
  vertical-align:middle
}

.progress-bar {
  float: left;
  width: 0%;
  height: 100%;
  font-size: 10px;
  line-height: 20px;
  color: #000000;
  text-align: center;
}

div.peregrine_falcon {
  content:url(<%= asset_path 'peregrine_falcon.png' %>);
  height: auto; 
  width: auto; 
  max-height: 16px; 
  display:inline;
  margin-left:10px;
  margin-right:10px;
  vertical-align:top;

}

div.golden_eagle {
  content:url(<%= asset_path 'golden_eagle.png' %>);
  height: auto; 
  width: auto; 
  max-height: 16px; 
  display:inline;
  margin-left:10px;
  margin-right:10px;
  vertical-align:top;

}

div.blue_wildebeest {
  content:url(<%= asset_path 'blue_wildebeest.png' %>);
  height: auto; 
  width: auto; 
  max-height: 16px; 
  display:inline;
  margin-left:10px;
  margin-right:10px;
  vertical-align:top;

}

div.pronghorn_antelope {
  content:url(<%= asset_path 'pronghorn_antelope.png' %>);
  height: auto; 
  width: auto; 
  max-height: 16px; 
  display:inline;
  margin-left:10px;
  margin-right:10px;
  vertical-align:top;

}

div.ostrish {
  content:url(<%= asset_path 'ostrish.png' %>);
  height: auto; 
  width: auto; 
  max-height: 16px; 
  display:inline;
  margin-left:10px;
  margin-right:10px;
  vertical-align:top;

}

div.cheetah {
  content:url(<%= asset_path 'cheetah.png' %>);
  height: auto; 
  width: auto; 
  max-height: 16px; 
  display:inline;
  margin-left:10px;
  margin-right:10px;
  vertical-align:top;

}

div.red_fox {
  content:url(<%= asset_path 'red_fox.png' %>);
  height: auto; 
  width: auto; 
  max-height: 16px; 
  display:inline;
  margin-left:10px;
  margin-right:10px;
  vertical-align:top;

}

div.brown_hare {
  content:url(<%= asset_path 'brown_hare.png' %>);
  height: auto; 
  width: auto; 
  max-height: 16px; 
  display:inline;
  margin-left:10px;
  margin-right:10px;
  vertical-align:top;

}

div.black_manba_snake {
  content:url(<%= asset_path 'black_manba_snake.png' %>);
  height: auto; 
  width: auto; 
  max-height: 16px; 
  display:inline;
  margin-left:10px;
  margin-right:10px;
  vertical-align:top;

}

div.mustang_horse {
  content:url(<%= asset_path 'mustang_horse.png' %>);
  height: auto; 
  width: auto; 
  max-height: 16px; 
  display:inline;
  margin-left:10px;
  margin-right:10px;
  vertical-align:top;

}

def speed_avatar_helper(speed)

  if speed >= 17.1
    "peregrine_falcon"
  elsif speed >= 15 && speed < 17.1
    "golden_eagle"
  elsif speed >= 13.3 && speed < 15
    "cheetah"
  elsif speed >= 12 && speed < 1.3
    "ostrish"
  elsif speed >= 10.9 && speed < 12
    "pronghorn_antelope"
  elsif speed >= 10 && speed < 10.9
    "blue_wildebeest"    
  elsif speed >= 9.2 && speed < 17.1
    "brown_hare"
  elsif speed >= 8.6 && speed < 17.1
    "red_fox"
  elsif speed >= 7.5 && speed < 17.1
    "mustang_horse"
  else
    "black_manba_snake"
  end
end ‚Äã

</style>

<%
if params[:week_number]
  week = params[:week_number]
else
  week = Date.today.at_beginning_of_week.strftime("%W").to_i
end
total_runners = total_km = runners_without_run = 0
range_date = Date.commercial(Time.now.year.to_i, week.to_i)

categories.each do |key, value|

  if @result[key].to_a.size>0

    runners = @result[key]
    total_runners = runners.to_a.size + total_runners

    runners.each do |runner| 

      runner_kms = runner.weekly_runs_km_on_date(range_date)
      total_km = total_km + runner_kms

      if runner_kms == 0

        runners_without_run = runners_without_run+1
      end
    end
  end
end

%>

<div>
    <div style="margin-left:10px">
    <div style="margin-top:10px">

<table class="tg">

  <tr>
<th class="tg-yi30">Week</th>
    <th class="tg-qacf"><%=  week %></th>
    <th class="tg-6eia">Total KMs</th>
    <th class="tg-qacf"><%= total_km.round(2) %></th>
    <th class="tg-u34r">#</th>
    <th class="tg-qacf"><%= total_runners %> üèÉ</th>
    <th class="tg-u34r">#üèÉ w/o KM</th>
    <th class="tg-qacf"><%= runners_without_run %></th>
  </tr> 
<% 
  categories.each do |key, value|


    if @result[key].to_a.size>0
      runners = @result[key]

    %>
      <tr>
        <td class="<%= key %>" colspan="8"><%= key %> (<%= value %>)</td>
      </tr>
    <tr>
    <td class="tg-scrz">#</td>
    <td class="tg-9d65">Athlete</td>
    <td class="tg-9d65">Target</td>
    <td class="tg-9d65">Real</td>
    <td class="tg-9d65">Runs</td>
    <td class="tg-9d65">Pace</td>
    <td class="tg-9d65">Km to Go</td>
    <td class="tg-9d65">%</td>
    </tr>  


  <% pos =0 %>

  <% runners.each do |runner| 

    range_date = Date.commercial(Time.now.year.to_i, week.to_i)

    next if runner.weekly_goal_on_date(range_date).nil?

    total_distance = runner.weekly_runs_km_on_date(range_date)
    runs_count = runner.weekly_runs_count_on_date(range_date)
    total_duration = runner.weekly_runs_duration_on_date(range_date)

    pos=pos+1
    percent = (total_distance/runner.weekly_goal_on_date(range_date).distance).round(2)*100

    if percent <= 30
      percent_css = "danger"
    elsif percent >30 and percent<=80
      percent_css = "warning"
    else
      percent_css = "success"
    end

    percent_limited = percent
    if percent > 100
      percent_limited = 100
    end

    total_distance_text = "%3.1f"%total_distance
    target_text = "%3.1f"%runner.weekly_goal_on_date(range_date).distance
    pace_text = pace_helper(total_duration,total_distance) 
    km_to_go_text = "%3.1f"%(runner.weekly_goal_on_date(range_date).distance-total_distance).round(1)
    pos_text = pos
    percent_text  = "%2d"%percent

    if runner.injured? || runner.quitted?
      runs_count = "n/a"
      total_distance_text = "n/a"
      target_text = "n/a"
      pace_text = "n/a"
      km_to_go_text = "n/a"
      pos_text = "n/a"
      percent_text = "n/a"
      percent_limited = 0
    end

    %> 

    <tr>
    <td class="tg-oskr"><%= pos_text %></td>
    <td class="tg-3x04">
    <% if runner.injured?%>üò∑ - <% end %><% if runner.quitted?%>üö´ - <% end %><%= runner.name %></td>
    <td class="tg-3x04"><%= target_text %></td>
    <td class="tg-3x04"><%= total_distance_text %></td>
    <td class="tg-3x04"><%= runs_count %></td>
    <td class="tg-3x04"><%= pace_text %><div class="<%= speed_avatar_helper(total_distance/(total_duration/60/60)) %>"></div>‚Äã</td>
    <td class="tg-3x04"><%= km_to_go_text%></td>
    <td class="tg-3x04">
      <div class="progress">
        <div class="progress-bar progress-bar-<%= percent_css %> progress-bar-striped" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width:<%= percent_limited %>%">
        <%= percent_text%>%
        </div>
      </div>
    </td>
  </tr>

  <% end %>
<% end %>
<% end %>
</table>
</div>
</div>

